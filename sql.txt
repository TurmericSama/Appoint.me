select
                a.*,
                b.*
            from
                appointments a join
                users b
            on
                a.repeat!="Ended" and
                time( now() )>=a.start_time and
                time( now() )<=a.end_time and
                a.date>=date( now() ) left join
                guests c
                    on
                        c.appointment_id=a.appointment_id and
                        if( c.user_id is not null, c.user_id, a.creator )=b.user_id